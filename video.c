//------------------------------------------------------------------------------
//             __             __   ___  __
//     | |\ | /  ` |    |  | |  \ |__  /__`
//     | | \| \__, |___ \__/ |__/ |___ .__/
//
//------------------------------------------------------------------------------

#include "video.h"
#include "spi.h"
#include "sam.h"
#include "delay.h"
#include "font.h"
#include <string.h>
//------------------------------------------------------------------------------
//      __   ___  ___         ___  __
//     |  \ |__  |__  | |\ | |__  /__`
//     |__/ |___ |    | | \| |___ .__/
//
//------------------------------------------------------------------------------

#define VIDEO_RST (PORT_PA18)
#define VIDEO_RST_GROUP (0)
#define VIDEO_RST_PIN (PIN_PA18%32)

#define VIDEO_CS (PORT_PA21)
#define VIDEO_CS_GROUP (0)
#define VIDEO_CS_PIN (PIN_PA21%32)

#define NO_OP                           0x0000
#define DISPLAY_DUTY                    0x0001
#define	RGB_INTERFACE					0x0002
#define	ENTRY_MODE						0x0003
#define	DISPLAY_CONTROL1				0x0005
#define	STAND_BY						0x0010
#define	OSC_REG							0x0018
#define	POWER_CONTROL3					0x00F8
#define	POWER_CONTROL4					0x00F9
#define	GRAM_ADDRESS_SET_X				0x0020
#define	GRAM_ADDRESS_SET_Y				0x0021
#define	GRAM_DATA_WRITE					0x0022
#define	GRAM_DATA_READ					0x0022
#define	IF_8BIT_BUS						0x0024
#define	VER_WINDOW_BEG					0x0035
#define	VER_WINDOW_END					0x0036
#define	HOR_WINDOW_BEGEND				0x0037
#define	GAMMA_TOPBOT_R					0x0070
#define	GAMMA_TOPBOT_G					0x0071
#define	GAMMA_TOPBOT_B					0x0072
#define	GAMMA_R12						0x0073
#define	GAMMA_R34						0x0074
#define	GAMMA_G12						0x0075
#define	GAMMA_G34						0x0076
#define	GAMMA_B12						0x0077
#define	GAMMA_B34						0x0078
#define	GAMMA_Q							0x0080

//------------------------------------------------------------------------------
//     ___      __   ___  __   ___  ___  __
//      |  \ / |__) |__  |  \ |__  |__  /__`
//      |   |  |    |___ |__/ |___ |    .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//                __          __        ___  __
//     \  /  /\  |__) |  /\  |__) |    |__  /__`
//      \/  /~~\ |  \ | /~~\ |__) |___ |___ .__/
//
//------------------------------------------------------------------------------

uint16_t pixels[] = {33813, 31700, 31733, 33878, 33910, 35991, 38103, 38103, 40216, 44440, 54939, 61342, 65503, 65535, 65503, 65503, 65503, 65535, 65535, 65502, 65503, 65502, 65470, 61277, 54972, 46521, 40215, 40151, 38103, 35990, 35958, 33878, 31765, 31734, 33846,
  29620, 29620, 31700, 33813, 33879, 35991, 38071, 42263, 52859, 63390, 65535, 65534, 65534, 65502, 65534, 65534, 65534, 65534, 65502, 65502, 65534, 65502, 65534, 65534, 65535, 63390, 50746, 42263, 38070, 35990, 35958, 33845, 31765, 31734, 31733,
  31733, 31700, 33813, 33878, 35959, 40151, 46521, 59165, 65534, 65534, 65533, 65501, 65502, 65502, 65502, 65534, 65533, 65501, 65501, 65502, 65502, 65502, 65502, 65502, 65502, 65534, 65503, 57053, 42296, 40119, 35959, 33910, 33846, 31733, 31765,
  33845, 31733, 33845, 35958, 38038, 48634, 65471, 65534, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65501, 65502, 59165, 44375, 38071, 35991, 33878, 31766, 33878,
  33877, 33878, 35927, 38038, 40215, 59197, 65502, 65469, 65501, 65501, 65500, 65468, 65468, 65468, 65468, 65468, 65500, 65500, 65500, 65501, 65469, 65469, 65501, 65501, 65501, 65501, 65502, 65469, 65534, 59165, 44344, 38071, 35991, 35926, 33878,
  35958, 33878, 38039, 38070, 50714, 65471, 65469, 65469, 65469, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65468, 65501, 65501, 65501, 65469, 65501, 65503, 57052, 40215, 38071, 35958, 35958,
  35990, 35958, 38071, 46488, 63358, 65501, 65469, 65469, 65437, 65436, 65436, 65435, 65436, 65436, 65435, 65436, 65436, 65435, 65436, 65436, 65436, 65468, 65468, 65468, 65468, 65469, 65469, 65501, 65469, 65469, 65470, 52827, 40151, 38071, 38071,
  38071, 38038, 40183, 57052, 65502, 65469, 65469, 65437, 65436, 65436, 65435, 65403, 65435, 65403, 65403, 65403, 65435, 65435, 65435, 65435, 65435, 65435, 65436, 65468, 65468, 65468, 65468, 65468, 65469, 65469, 65501, 61278, 44376, 38071, 38071,
  40151, 40119, 48569, 63358, 65437, 65437, 65436, 65436, 65403, 65403, 65435, 65403, 65402, 65403, 65403, 65402, 65402, 65402, 65402, 65402, 65403, 65435, 65435, 65436, 65436, 65468, 65468, 65468, 65468, 65469, 65469, 65470, 50747, 40151, 40184,
  40184, 42263, 54972, 63390, 65436, 65436, 65404, 65403, 65403, 65403, 65371, 65370, 65402, 65370, 65370, 65370, 65370, 65370, 65370, 65402, 65402, 65403, 65403, 65435, 65435, 65435, 65436, 65468, 65436, 65469, 65469, 65470, 59165, 42296, 40184,
  40184, 44440, 61277, 63389, 63388, 63356, 65403, 63323, 65371, 65371, 63290, 65338, 65338, 65306, 65306, 65337, 65337, 63257, 65337, 65369, 65402, 65402, 65402, 65403, 65403, 65403, 65435, 65436, 65436, 65436, 65437, 65469, 63390, 48601, 40183,
  40216, 48601, 63357, 63356, 63356, 63323, 63323, 63322, 63291, 63258, 63258, 63257, 65305, 65273, 65305, 63257, 63257, 63224, 65305, 63289, 63289, 63290, 63322, 65370, 65402, 65403, 65403, 65404, 65404, 65436, 65437, 65469, 65470, 50746, 42264,
  42296, 52826, 63356, 63356, 63355, 63323, 63290, 63290, 63258, 63257, 63225, 63224, 63224, 63257, 63257, 63224, 63224, 63192, 63224, 63224, 63192, 63225, 63289, 63289, 65338, 65370, 65371, 65371, 65403, 65436, 65436, 65437, 65469, 54906, 44344,
  44376, 54971, 63356, 63356, 63323, 63290, 63290, 63258, 61209, 61177, 61144, 61176, 61175, 61143, 61143, 63224, 61143, 61143, 63223, 63223, 63224, 63256, 63224, 63224, 63257, 63289, 63290, 63290, 63323, 65403, 65404, 65437, 65469, 57019, 44376,
  44409, 54939, 63357, 63323, 63323, 63290, 63258, 61209, 61176, 61144, 61143, 61143, 61110, 61078, 61013, 61013, 61013, 63094, 63126, 65174, 63127, 63159, 59030, 59063, 61176, 63257, 61209, 63257, 65370, 63323, 63323, 65404, 65469, 61245, 46489,
  44409, 52826, 63356, 63323, 63291, 63258, 63258, 61177, 61144, 61112, 61143, 59030, 58997, 58965, 60981, 62964, 64980, 64980, 64980, 64980, 62899, 62964, 61013, 59030, 61079, 61143, 61144, 63257, 63258, 63290, 63323, 65404, 63388, 61277, 48569,
  44441, 50714, 61308, 63324, 63291, 63258, 61210, 61145, 61112, 59031, 59030, 58997, 58933, 58836, 62932, 64948, 64948, 64948, 64948, 64948, 64948, 64916, 60819, 58803, 60981, 58998, 59031, 59063, 61177, 63258, 63291, 65404, 63356, 61277, 48601,
  44441, 48602, 61244, 63323, 61242, 63258, 61177, 61144, 59063, 58998, 56852, 56723, 58771, 62836, 64948, 64916, 64916, 64948, 64948, 64947, 64915, 64884, 64819, 58544, 56658, 56917, 56885, 59031, 59096, 61177, 63290, 63323, 63388, 61277, 50682,
  44441, 48570, 59164, 63356, 63291, 61210, 61145, 59064, 56950, 54804, 52561, 56529, 60657, 62803, 64883, 64851, 64851, 64883, 64851, 64818, 62738, 62770, 62738, 58512, 56528, 58965, 54836, 56950, 59063, 61145, 63258, 63323, 63388, 63356, 50714,
  46489, 46489, 54907, 61309, 61242, 61209, 59129, 59063, 56918, 54804, 54641, 54415, 54319, 52271, 50125, 50061, 54254, 58480, 60592, 56366, 45931, 43883, 50157, 52238, 52270, 54642, 59030, 59030, 59063, 61177, 63290, 63323, 63355, 61212, 48601,
  46521, 46521, 50714, 61244, 61243, 61210, 61210, 59096, 59031, 56885, 52529, 50222, 50158, 41738, 33384, 37513, 50125, 56399, 60592, 50093, 39625, 33384, 35497, 43819, 52238, 50319, 58998, 56982, 59031, 61177, 61210, 61242, 63356, 59164, 48569,
  46521, 46521, 50682, 59165, 61243, 61210, 59130, 59129, 59096, 56885, 56658, 52302, 41705, 39658, 39723, 45997, 54383, 60626, 64754, 54319, 45964, 43884, 43852, 43850, 45996, 54415, 60981, 59063, 59064, 61145, 61178, 61242, 61276, 57051, 48569,
  46521, 48602, 48634, 57020, 61211, 61210, 61211, 59097, 59032, 58999, 56658, 58609, 58577, 56496, 56464, 58512, 58512, 60561, 62641, 58415, 56367, 56464, 56465, 58609, 58641, 56431, 56787, 59096, 59064, 59065, 61178, 59130, 59163, 54906, 48569,
  48569, 48602, 48634, 54939, 61243, 61242, 61211, 59130, 61145, 61112, 54546, 60657, 64850, 64818, 62803, 62673, 60528, 60561, 64787, 58480, 54254, 60560, 64786, 62738, 60624, 56431, 56788, 61144, 59032, 57017, 57017, 59097, 57050, 52794, 48602,
  48601, 48602, 48666, 54971, 61244, 61242, 61210, 61210, 59129, 59031, 56626, 60593, 62705, 64883, 62738, 52141, 54222, 54222, 60529, 54222, 49996, 52108, 62705, 64818, 60592, 56430, 56755, 61144, 59064, 59065, 59097, 59130, 57051, 50681, 48602,
  48602, 48602, 50715, 52826, 59164, 61243, 61210, 59129, 59129, 59063, 56658, 58512, 60560, 60593, 47915, 45802, 47915, 45770, 45803, 43690, 45835, 45802, 50060, 60560, 58446, 56398, 52530, 56918, 59032, 56984, 59097, 57050, 54939, 50714, 50682,
  48634, 50682, 50715, 52794, 57052, 61243, 61210, 59097, 59032, 56950, 54642, 52302, 54286, 50125, 47979, 56367, 56368, 56368, 54255, 54287, 54254, 52206, 47980, 52173, 54252, 52237, 50449, 56951, 56951, 56984, 54904, 54971, 52827, 50714, 50714,
  48634, 50682, 50746, 52827, 52827, 59163, 59130, 59097, 59064, 56950, 50514, 52399, 54318, 52173, 45899, 45835, 43755, 50094, 54320, 47981, 43722, 43754, 43786, 52173, 52205, 50189, 46255, 56886, 56919, 56952, 54937, 54939, 50746, 50714, 50714,
  50682, 50714, 50747, 52827, 52794, 54939, 59131, 59097, 56983, 54870, 48466, 50415, 52334, 56431, 52238, 45834, 50061, 56400, 56400, 54287, 47915, 45867, 54351, 54318, 50189, 48174, 46353, 54838, 54872, 56954, 54939, 52794, 50747, 50715, 50714,
  50714, 50715, 52795, 52795, 52795, 52827, 54971, 57083, 57017, 57017, 56984, 50448, 52398, 54382, 56463, 56399, 56335, 58415, 56334, 56335, 54254, 56399, 56399, 52269, 46125, 50450, 56986, 54906, 54907, 54875, 52794, 52795, 52795, 50714, 52795,
  50714, 50715, 52795, 52827, 52795, 52794, 52826, 52859, 54907, 54939, 52726, 50480, 52430, 50253, 52302, 58480, 58513, 58512, 58448, 56431, 56432, 54351, 50189, 48108, 44044, 50515, 56987, 50747, 50746, 52794, 52794, 52795, 52794, 50746, 52794,
  50747, 50747, 52827, 52827, 52795, 52795, 52827, 52827, 52827, 59164, 54774, 48368, 52431, 50286, 48174, 54384, 60690, 62771, 62706, 62706, 58545, 50222, 46028, 41867, 44012, 42030, 48436, 54874, 52827, 50746, 52794, 52795, 52762, 52762, 52795,
  52795, 52795, 52795, 52795, 52795, 52795, 52827, 52795, 54939, 63357, 61145, 46288, 48303, 48205, 48173, 48141, 54383, 58513, 56432, 54352, 50190, 45996, 41802, 43915, 46125, 44077, 37868, 54839, 59165, 52794, 50746, 52762, 52762, 52762, 52795,
  52827, 52795, 52795, 52795, 52795, 52795, 52795, 50747, 59133, 65373, 65403, 56918, 46158, 48172, 46091, 48108, 43915, 39690, 39658, 39625, 39722, 41866, 41898, 46059, 48205, 48238, 44076, 56886, 63325, 57019, 50714, 52762, 52762, 50714, 52795,
  52828, 50747, 50747, 52827, 52795, 50746, 52794, 57020, 63357, 63324, 63290, 65436, 54773, 46254, 44012, 45995, 43915, 39721, 37576, 39656, 41801, 41833, 43946, 48171, 50350, 54544, 48270, 54805, 61242, 61244, 54906, 50714, 50714, 50714, 52794,
  52827, 50779, 50779, 50746, 52794, 57019, 61245, 63390, 65405, 63324, 63290, 59097, 59096, 63289, 54708, 43979, 45994, 43881, 43881, 43849, 41768, 43881, 50155, 50284, 52462, 56721, 52561, 59030, 56919, 61275, 63390, 57084, 52826, 52793, 52794,
  52827, 50747, 50746, 54972, 61245, 63357, 65470, 63421, 65436, 63355, 65403, 61209, 61144, 63291, 63290, 46157, 48140, 46027, 45994, 43913, 45993, 50219, 52365, 54478, 54608, 58835, 56819, 56918, 54838, 63323, 65502, 65535, 65471, 63358, 59197,
  54940, 57052, 59164, 63422, 63356, 63356, 65468, 65467, 65467, 65435, 65435, 59096, 59031, 65403, 61111, 41930, 50252, 50252, 52332, 54445, 54510, 54477, 54477, 56590, 58801, 58835, 59030, 56983, 61209, 59129, 65468, 65534, 65535, 65535, 65535,
  63389, 65501, 65469, 63420, 63387, 65468, 65500, 65500, 65468, 65435, 65435, 56950, 59031, 65370, 54739, 41864, 52364, 52332, 56525, 58606, 56590, 56557, 54509, 56590, 56688, 58997, 63321, 63322, 56951, 54902, 65500, 65502, 65502, 65502, 65502,
  63421, 63356, 63388, 63387, 63355, 65468, 65468, 65500, 65468, 65435, 65402, 59031, 61143, 63289, 50480, 43945, 54444, 54380, 54379, 54380, 54412, 54412, 54509, 58703, 54543, 56884, 65468, 63322, 54838, 61209, 65500, 65501, 65502, 65502, 65502,
  65469, 63388, 65468, 65435, 63355, 65468, 65500, 65500, 65468, 65435, 63322, 59128, 63256, 63256, 56819, 50252, 52299, 54347, 54282, 54250, 54283, 54380, 58638, 58639, 50284, 54706, 65468, 59161, 63290, 65403, 65468, 65501, 65501, 65502, 65534,
  65469, 65436, 65467, 65435, 63354, 65467, 65499, 63419, 65468, 65435, 65402, 63321, 58997, 58835, 60915, 54446, 54316, 54284, 54251, 54218, 54219, 56396, 58541, 54413, 48139, 52658, 65435, 61242, 63322, 65403, 63387, 65501, 65533, 65501, 65502,
  65468, 63355, 65435, 63387, 63322, 65435, 65468, 65467, 65468, 65468, 63289, 63191, 50383, 48140, 48075, 45963, 52237, 52204, 54219, 54218, 54251, 58445, 56397, 52268, 48140, 58965, 63354, 63355, 63290, 65403, 63420, 65501, 65501, 65502, 65502,
  65436, 65435, 65467, 65435, 63354, 65403, 65468, 65468, 63387, 65435, 61111, 61045, 52496, 37640, 37640, 52399, 52366, 48075, 50090, 52170, 54251, 56332, 54316, 52234, 50318, 63322, 63322, 65436, 61210, 63355, 63420, 65501, 65501, 65501, 65502,
  65436, 63387, 65467, 65435, 65435, 63322, 65468, 65468, 65402, 58998, 52561, 56690, 56756, 58966, 54739, 54706, 50317, 56624, 56559, 52268, 50122, 52138, 50089, 48106, 54771, 65435, 63323, 65436, 61210, 65403, 65468, 65501, 65501, 65501, 65501,
  63355, 63355, 65435, 65435, 65435, 63322, 63355, 65500, 65402, 58964, 58835, 54544, 54577, 54642, 52593, 60915, 56624, 48204, 65043, 62898, 50123, 50057, 45928, 46156, 61176, 63290, 63323, 65436, 61209, 65435, 65500, 65501, 65501, 63421, 63421,
  63355, 63355, 63355, 63387, 63387, 63354, 63354, 65435, 58998, 54641, 56689, 54545, 54545, 41964, 50415, 56689, 50349, 52332, 58607, 62801, 50155, 47976, 45928, 52496, 65403, 61209, 63355, 65435, 61241, 63387, 65500, 63453, 63421, 63421, 63389,
  61275, 61242, 61274, 63355, 63355, 63355, 65435, 61241, 54739, 56722, 54577, 54577, 48336, 46288, 58999, 52627, 41898, 48074, 48106, 50220, 48107, 48041, 46026, 58933, 65468, 59129, 65436, 63387, 61241, 65467, 65501, 63421, 63421, 63388, 61309,
  59162, 59162, 59194, 61242, 61274, 61274, 63355, 61177, 50481, 56658, 54545, 35593, 25126, 33642, 35820, 39981, 37770, 33446, 33447, 46190, 52529, 46092, 48238, 63290, 63323, 61177, 65468, 63356, 61242, 63387, 65501, 63421, 63389, 61308, 59196,
  57017, 57049, 59130, 59162, 59162, 59162, 61242, 59064, 48271, 48174, 52368, 35529, 27141, 27238, 23076, 18851, 29384, 27303, 33644, 65501, 65436, 44175, 50449, 65436, 61275, 63323, 63388, 63356, 61242, 63355, 63421, 63388, 61308, 59196, 57115,
  52825, 52825, 54905, 54937, 56985, 57017, 59097, 56984, 42062, 44045, 46126, 46061, 27141, 33576, 37802, 20932, 20997, 52790, 63324, 63356, 65501, 46387, 35821, 40144, 50709, 65501, 65404, 65404, 63291, 61275, 61307, 59162, 59163, 57083, 54971,
  46552, 46552, 48600, 48632, 50712, 52792, 52824, 54904, 42128, 37804, 33545, 39788, 39787, 31367, 31432, 33708, 50678, 65534, 65501, 63388, 65469, 61243, 57017, 35951, 50710, 65534, 63388, 63323, 63355, 61242, 61275, 57082, 57083, 54970, 52858,
  42359, 42327, 42326, 42358, 46487, 46519, 48599, 50712, 42130, 29353, 31466, 31401, 29255, 33481, 31530, 59097, 65534, 63421, 63421, 63421, 63420, 65534, 61308, 59195, 63389, 65469, 63389, 61275, 63356, 59130, 61243, 59164, 55003, 52858, 48698,
  36054, 36022, 36054, 38101, 40214, 42294, 44374, 46487, 44341, 27339, 27338, 25192, 27240, 31498, 33708, 57049, 63389, 61340, 63388, 63388, 63420, 63389, 57115, 63421, 63389, 63389, 63389, 61275, 63356, 59162, 59130, 59132, 54939, 50746, 46618,
  29781, 29748, 31861, 33909, 36022, 38102, 38069, 40149, 42229, 29551, 23179, 27307, 35759, 35791, 37935, 56985, 61276, 61276, 61276, 61308, 61308, 61276, 61276, 63357, 61276, 61276, 61276, 61244, 61243, 59163, 57050, 57051, 52858, 48665, 44505,
  23475, 23475, 27636, 29749, 31861, 36021, 38134, 46553, 50746, 42229, 31665, 33778, 38003, 35890, 40147, 52793, 57083, 57083, 57115, 59163, 59163, 59164, 59164, 59164, 59164, 59164, 59163, 59163, 59163, 59131, 54937, 54938, 50746, 46553, 40312,
  40280, 38200, 40280, 40313, 42392, 48731, 52924, 52858, 57084, 54971, 50746, 46520, 44407, 50713, 54939, 57052, 59164, 59164, 59196, 59196, 59196, 59197, 59197, 61245, 61245, 61245, 61277, 61277, 61277, 61277, 59164, 57084, 55004, 52859, 50779,
};

//------------------------------------------------------------------------------
//      __   __   __  ___  __  ___      __   ___  __
//     |__) |__) /  \  |  /  \  |  \ / |__) |__  /__`
//     |    |  \ \__/  |  \__/  |   |  |    |___ .__/
//
//------------------------------------------------------------------------------

static void video(uint16_t index, uint16_t parameter);
static void video_index(uint16_t val);
static void video_parameter(uint16_t val);
static inline void chipsel_on();
static inline void chipsel_off();
static void video_draw_test_screen();
static void print_pixel_count(uint8_t count, uint16_t color);

//------------------------------------------------------------------------------
//      __        __          __
//     |__) |  | |__) |    | /  `
//     |    \__/ |__) |___ | \__,
//
//------------------------------------------------------------------------------

//==============================================================================
void video_init()
{
  // Set up the Video pins as outputs
  PORT->Group[VIDEO_RST_GROUP].DIRSET.reg = VIDEO_RST;
  PORT->Group[VIDEO_CS_GROUP].DIRSET.reg = VIDEO_CS;

  // Turn the outputs "off"
  PORT->Group[VIDEO_RST_GROUP].OUTSET.reg = VIDEO_RST; // active low
  PORT->Group[VIDEO_CS_GROUP].OUTSET.reg = VIDEO_CS;   // active low

  // Enable the SPI
  spi_init();

  // Wait here for a bit until we know the reset pulse has been big enough.  
  // PAMO-C0201QILK-C Application Note - 3. Power Sequence 
  DelayMs(500);
  PORT->Group[VIDEO_RST_GROUP].OUTCLR.reg = VIDEO_RST; // turn it on 
  DelayMs(20); // Leave it on for a bit. 
  PORT->Group[VIDEO_RST_GROUP].OUTSET.reg = VIDEO_RST; // turn it off
  DelayMs(10);
  video(STAND_BY, 0x0000); // Cancel Standby Mode
  DelayMs(100);
  // The following are specified by page 12 of PAMO-C0201QILK-C.pdf
  video(POWER_CONTROL3, 0x000F);
  video(POWER_CONTROL4, 0x0019);
  DelayMs(32);

  // The following are specified by page 12 of PAMO-C0201QILK-C.pdf

  // Set FP and BP to 8 and the Number of Lines to be 240x224
  // Our display is 176x220. I don't know why they picked 224 here. 
  // I guess it is just the first thing bigger than 220. That said, the 
  // X direction doesn't begin until 0x20 (32) - which, if 
  video(DISPLAY_DUTY, 0x881C); 


  // The RGB Interface is unused - Set DM to 0. 
  video(RGB_INTERFACE, 0x0000);
  // Set the SS bit in the Entry Mode to put 0,0 at the top  left
  // Set up the ID to auto increase the Address Counter after GRAM write
  // Increase X in the window until it hits the edge, then return and increment Y
  video(ENTRY_MODE, 0x0130);
  // Turn off the Display
  video(DISPLAY_CONTROL1, 0x0000); // Turn off display
  //video(STAND_BY, 0x0000);
  // Set the Internal Oscilllator to Max
  video(OSC_REG, 0x0028);
  // The X address starts at 0x20. Why?? No clue.
  // 176 + 32 is 198. So .. that's not it. However, 176 + 64 = 240.  I wonder 
  // if the designer figured on a 240 wide and just slapped te 176 in the middle? 
  // Again - no clue. But - we need to start the X at 0x0020 to get it to show up
  // at the left edge of the screen. 
  video(GRAM_ADDRESS_SET_X, 0x0020); 
  // The Vertical starts at 0 ... that makes sense. 
  video(GRAM_ADDRESS_SET_Y, 0x0000); // Vertical starts at 0.
  // Set up the window to match the entire screen. 
  video(VER_WINDOW_BEG, 0x0000); // Window vertical start (0)
  video(VER_WINDOW_END, 0x00DB); // Window vertical end (219)
  // Horizontal starts at 0x20 and last for 0xAF (176 - 1) - so the end is 0xCF. 
  video(HOR_WINDOW_BEGEND, 0x20CF); 
  
  // Gamma settings from the test doc
  video(GAMMA_TOPBOT_R, 0x3300);
  video(GAMMA_TOPBOT_G, 0x3900);
  video(GAMMA_TOPBOT_B, 0x3800);
  video(GAMMA_R12, 0x2924);
  video(GAMMA_R34, 0x261C);
  video(GAMMA_G12, 0x3125);
  video(GAMMA_G34, 0x271C);
  video(GAMMA_B12, 0x352A);
  video(GAMMA_B34, 0x2A1E);

  //video_draw_test_screen();

  // Turn on the display
  video(DISPLAY_CONTROL1, 0x0001);
}

void video_print_sprite(uint8_t x, uint8_t y)
{
  int i;
  uint8_t xpos = x;
  uint8_t ypos = y;
  
  video_set_window(xpos,ypos,35,57);
  video(GRAM_ADDRESS_SET_X, xpos + 0x0020);
  video(GRAM_ADDRESS_SET_Y, ypos);
  video_index(GRAM_DATA_WRITE);
  chipsel_on();
  spi_write(0x72);
  
  for(i = 0; i < 1995; i++)
  {
    print_pixel_count(1,pixels[i]);
  }
  
  chipsel_off();
  
  video(NO_OP, 0x0000);
}

//==============================================================================
void video_off()
{
	  video(DISPLAY_CONTROL1, 0x0000);
}

//==============================================================================
void video_on()
{
	video(DISPLAY_CONTROL1, 0x0001);
}

//==============================================================================
void video_set_window(uint8_t x, uint8_t y, uint8_t width, uint8_t height)
{
  uint16_t begend;
  
  // Do the 0x20 shift on X so that we can deal with a base 0 window system. 
  x = x + 0x20; 
  
  // Set up the vertical window
  video(VER_WINDOW_BEG, y); // Window vertical start 
  video(VER_WINDOW_END, y + height -1); // Window vertical end (-1)
  
  // Set up the horizontal window. 
  begend = (x << 8) | (x + width -1); 
  video(HOR_WINDOW_BEGEND, begend);	
}

//==============================================================================
void video_paint_rect(uint8_t x, uint8_t y, uint8_t width, uint8_t height, uint16_t color)
{
  uint16_t i;
  video_set_window(x,y,width,height);
  video(GRAM_ADDRESS_SET_X, x + 0x0020);
  video(GRAM_ADDRESS_SET_Y, y); 
  video_index(GRAM_DATA_WRITE);
  chipsel_on();
  spi_write(0x72);
  
  for (i = 0; i < width * height; i++)
  {
	//video_parameter(color);
	spi_write(color >> 8);
	spi_write(color & 0xFF);
  }
  chipsel_off();
  
  video(NO_OP, 0x0000);
}

// foreground and background
void video_print_string(uint8_t * string, font_t * font, uint8_t x, uint8_t y, 
                        uint16_t fg, uint16_t bg)
{
  uint16_t i;
  uint16_t j;
  uint16_t k;

  uint8_t character;

  uint8_t width = font->width * strlen(string);
  uint8_t height = font->height;
  uint8_t length = strlen(string);

  uint8_t bytes_per_row = ( ( (font->width) - 1) / 8) + 1;

  video_set_window(x,y,width,height);
  video(GRAM_ADDRESS_SET_X, x + 0x0020);
  video(GRAM_ADDRESS_SET_Y, y); 
  video_index(GRAM_DATA_WRITE);
  chipsel_on();
  spi_write(0x72);
  
  // ROWS
  for (i = 0; i < height; i++)
  {
    // CHAR 
	  for(j = 0; j < length; j++)
    {
      character = (string[j] - 32);
      // COLUMNS
      for(k = 0; k < font->width; k++)
      {
        if(((font->ptr[((character) * height)*bytes_per_row + i*bytes_per_row + (k/8)])) & (1 << (7 - (k%8))) )
        {
          spi_write(fg >> 8);
          spi_write(fg & 0xFF);
        }
        else
        {
          spi_write(bg >> 8);
          spi_write(bg & 0xFF);
        }

      } // columns
    } // chars
  } // rows 
  chipsel_off();
  
  // width/8

  video(NO_OP, 0x0000);
}
//------------------------------------------------------------------------------
//      __   __              ___  ___
//     |__) |__) | \  /  /\   |  |__
//     |    |  \ |  \/  /~~\  |  |___
//
//------------------------------------------------------------------------------

//==============================================================================
static void video(uint16_t index, uint16_t parameter)
{
  video_index(index);
  video_parameter(parameter);
}

//==============================================================================
static void video_index(uint16_t val)
{
  chipsel_on();
  spi_write(0x70);
  spi_write(0x00);
  spi_write(val & 0x00FF);
  chipsel_off();
}

//==============================================================================
static void video_parameter(uint16_t val)
{
  chipsel_on();
  spi_write(0x72);
  spi_write(val >> 8);
  spi_write(val & 0xFF);
  chipsel_off();
}

//==============================================================================
static void video_draw_test_screen()
{
  uint16_t i,j;
  uint16_t color;

  video_index(GRAM_DATA_WRITE);

  for (i = 0; i < 176*220; i++)
  {
    color = 0x7BEF;
    if (i >= 176*20) color = 0xF800; // Red
    if (i >= 176*40) color = 0x07E0; // Green
    if (i >= 176*60) color = 0x001F; // Blue
    if (i >= 176*80) color = 0x0000; // Black
    if (i >= 176*100) color = 0xFFFF; // White
    if (i >= 176*120) color = 0xF81F; // Magenta
    if (i >= 176*140) color = 0xFFE0; // Yellow
    if (i >= 176*160) color = 0x07FF; // Cyan
    if (i >= 176*180) color = 0xF3E0; // Orange
    if (i >= 176*200) color = 0x781F; // Purple

    video_parameter(color);
  }
  // Write address 0 to stop the cycle
  video(NO_OP, 0x0000);

  // Let's draw a square in the middle of the screen. Make it RED.
  color = 0xF800;
  for (i = 20; i < 120; i++)
  {
    video(GRAM_ADDRESS_SET_X, (uint16_t) (0x0020 + 10));
    video(GRAM_ADDRESS_SET_Y, (uint16_t) (i));
    video_index(GRAM_DATA_WRITE);

    for (j = 0; j < 10; j++)
    {
      video_parameter(color);
    }
    video(NO_OP, 0x0000);
  }
  
  
}

static void print_pixel_count(uint8_t count, uint16_t color)
{
  for (int i = 0; i < count; i++)
  {
    spi_write(color >> 8);
    spi_write(color & 0xFF);
  }
}

//==============================================================================
static void inline chipsel_on()
{
  PORT->Group[VIDEO_CS_GROUP].OUTCLR.reg = VIDEO_CS; // active low
}

//==============================================================================
static void inline chipsel_off()
{
  PORT->Group[VIDEO_CS_GROUP].OUTSET.reg = VIDEO_CS; // active low
}

//------------------------------------------------------------------------------
//      __                  __        __        __
//     /  `  /\  |    |    |__)  /\  /  ` |__/ /__`
//     \__, /~~\ |___ |___ |__) /~~\ \__, |  \ .__/
//
//------------------------------------------------------------------------------

//------------------------------------------------------------------------------
//        __   __  , __
//     | /__` |__)  /__`   
//     | .__/ |  \  .__/
//
//------------------------------------------------------------------------------
